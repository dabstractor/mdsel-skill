# tsup Configuration Research for Node.js MCP Servers

## Official Documentation URLs

- **Official tsup Documentation**: https://tsup.egoist.dev/
- **GitHub Repository**: https://github.com/egoist/tsup
- **esbuild Documentation** (tsup is built on esbuild): https://esbuild.github.io/

## 1. tsup Configuration for ESM Output Targeting Node.js 18+

### Basic ESM Configuration

```typescript
// tsup.config.ts
import { defineConfig } from 'tsup'

export default defineConfig({
  entry: ['src/index.ts'],
  format: ['esm'], // ESM format for Node.js 18+
  platform: 'node', // Target Node.js platform
  target: 'node18', // Target Node.js 18+
  dts: true, // Generate TypeScript declaration files
  outDir: 'dist', // Output directory
  clean: true, // Clean output directory before build
})
```

### Dual Package Support (CJS + ESM)

For maximum compatibility, especially for MCP servers that might be used in different environments:

```typescript
// tsup.config.ts
import { defineConfig } from 'tsup'

export default defineConfig({
  entry: ['src/index.ts'],
  format: ['cjs', 'esm'], // Both CommonJS and ESM
  platform: 'node',
  target: 'node18',
  dts: true,
  outDir: 'dist',
  clean: true,
  // Generate separate entry points for each format
  entryPoints: ['src/index.ts'],
  splitting: false, // Disable code splitting for better bundle size
})
```

## 2. Entry Points, Output Directory, and Type Declarations

### Entry Points Configuration

```typescript
// Multiple entry points
export default defineConfig({
  entry: {
    index: 'src/index.ts',
    cli: 'src/cli.ts',
    server: 'src/server.ts',
  },
  format: ['esm', 'cjs'],
  dts: true,
  outDir: 'dist',
})

// Single entry with different formats
export default defineConfig({
  entry: ['src/index.ts'],
  format: ['esm', 'cjs'],
  outDir: 'dist',
  dts: {
    // Type declaration options
    resolve: true,
    banner: '/* Generated by tsup */',
  },
})
```

### Output Directory Management

```typescript
export default defineConfig({
  entry: ['src/index.ts'],
  format: ['esm', 'cjs'],
  outDir: 'dist',
  // Subdirectory organization
  esm: {
    dir: 'dist/esm',
  },
  cjs: {
    dir: 'dist/cjs',
  },
  dts: {
    dir: 'dist/types',
  },
})
```

## 3. Best Practices for Building TypeScript CLI Tools/Executables

### CLI Tool Configuration

```typescript
// tsup.config.ts for CLI
import { defineConfig } from 'tsup'

export default defineConfig({
  entry: ['src/cli.ts'],
  format: 'cjs', // CLI tools typically use CJS for better compatibility
  platform: 'node',
  target: 'node18',
  dts: true,
  outDir: 'dist',
  // Add shebang for direct execution
  banner: {
    js: '#!/usr/bin/env node',
  },
  // Minify for production
  minify: process.env.NODE_ENV === 'production',
  // Ensure proper file permissions
  postBuild: [
    'chmod +x dist/cli.js',
  ],
})
```

### MCP Server Specific Configuration

```typescript
// tsup.config.ts for MCP Server
import { defineConfig } from 'tsup'

export default defineConfig({
  // Main entry point for the MCP server
  entry: ['src/index.ts'],
  format: ['esm', 'cjs'], // Support both formats
  platform: 'node',
  target: 'node18',
  dts: true,
  outDir: 'dist',
  // External dependencies that shouldn't be bundled
  external: [
    '@modelcontextprotocol/sdk',
    'node:*', // Don't bundle Node.js built-ins
  ],
  // Bundle everything else
  noExternal: [],
  // Development settings
  sourcemap: process.env.NODE_ENV !== 'production',
  minify: process.env.NODE_ENV === 'production',
  // Watch mode for development
  watch: process.env.NODE_ENV === 'development',
  // Clean output before build
  clean: true,
})
```

## 4. Common tsup Options and Their Purposes

### Core Configuration Options

| Option | Type | Purpose |
|--------|------|---------|
| `entry` | `string \| string[] \| Record<string, string>` | Entry point(s) for the bundle |
| `format` | `'esm' \| 'cjs' \| 'iife' \| array` | Output format(s) |
| `outDir` | `string` | Output directory |
| `platform` | `'node' \| 'browser' \| 'neutral'` | Target platform |
| `target` | `string \| string[]` | JavaScript target version |
| `dts` | `boolean \| object` | Generate TypeScript declarations |
| `external` | `string[]` | Dependencies to not bundle |
| `noExternal` | `string[]` | Force bundling of dependencies |

### Build Optimization Options

| Option | Type | Purpose |
|--------|------|---------|
| `minify` | `boolean` | Minify the output |
| `sourcemap` | `boolean` | Generate source maps |
| `splitting` | `boolean` | Enable code splitting |
| `bundle` | `boolean` | Bundle dependencies |
| `treeshake` | `boolean` | Apply tree shaking |

### Advanced Options

| Option | Type | Purpose |
|--------|------|---------|
| `banner` | `object` | Add banner to output files |
| `footer` | `object` | Add footer to output files |
| `define` | `object` | Global replacements |
| `inject` | `string[]` | Inject files into bundle |
| `jsx` | `'preserve' \| 'react' \| 'transform'` | JSX transform option |

## 5. Common Gotchas and Solutions

### Gotcha 1: ESM and CJS Module Resolution

**Problem**: Mixed ESM/CJS imports cause runtime errors
```typescript
// Problem: CJS importing ESM
const { something } = require('./dist/esm/index.mjs') // ❌
```

**Solution**: Use proper package.json exports

```json
// package.json
{
  "type": "module",
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "require": "./dist/index.cjs",
      "types": "./dist/index.d.ts"
    }
  }
}
```

### Gotcha 2: Node.js Built-ins

**Problem**: tsup tries to bundle Node.js built-ins
```bash
Error: Cannot bundle Node.js built-in module "fs"
```

**Solution**: Externalize Node.js built-ins

```typescript
// tsup.config.ts
export default defineConfig({
  entry: ['src/index.ts'],
  format: ['esm', 'cjs'],
  external: [
    'node:*',
    'buffer',
    'process',
  ],
})
```

### Gotcha 3: Type Declaration Generation

**Problem**: Type declarations don't match the actual output
```typescript
// Problem: Types point to .mjs files in CJS build
declare module 'my-package' {
  export function doSomething(input: string): Promise<number>;
  // Points to wrong file extension
}
```

**Solution**: Configure dts options properly

```typescript
// tsup.config.ts
export default defineConfig({
  dts: {
    // Generate separate declaration files for each format
    entryPoint: {
      index: 'src/index.ts',
      cli: 'src/cli.ts',
    },
    // Resolve relative imports correctly
    resolve: true,
    // Use .d.ts extension consistently
    extension: '.d.ts',
  },
})
```

### Gotcha 4: File Extensions in ESM

**Problem**: ESM output doesn't include file extensions
```bash
# Problem: Import without extension
import { something } from 'my-package' // ❓
```

**Solution**: Configure exports in package.json

```json
// package.json
{
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "types": "./dist/index.d.ts"
    }
  }
}
```

### Gotcha 5: Development Watch Mode

**Problem**: Watch mode doesn't reload properly
```typescript
// Problem: Changes don't trigger rebuild
export default defineConfig({
  watch: true, // Not working as expected
})
```

**Solution**: Use proper watch configuration

```typescript
// tsup.config.ts
export default defineConfig({
  watch: process.env.NODE_ENV === 'development',
  onBuildComplete: () => {
    console.log('Build complete! Watching for changes...');
  },
})
```

## 6. Complete MCP Server Example

### Project Structure

```
mcp-server/
├── src/
│   ├── index.ts          # Main server entry
│   ├── server.ts         # MCP server implementation
│   ├── cli.ts            # CLI tool
│   └── types.ts          # Type definitions
├── tsup.config.ts        # tsup configuration
├── package.json
└── tsconfig.json
```

### tsup.config.ts

```typescript
import { defineConfig } from 'tsup'
import { execSync } from 'child_process'

export default defineConfig({
  // Entry points
  entry: {
    main: 'src/index.ts',
    server: 'src/server.ts',
    cli: 'src/cli.ts',
  },

  // Output formats
  format: ['esm', 'cjs'],

  // Target Node.js 18+
  platform: 'node',
  target: 'node18',

  // Output configuration
  outDir: 'dist',
  clean: true,

  // Type declarations
  dts: {
    entryPoint: {
      main: 'src/index.ts',
      server: 'src/server.ts',
      cli: 'src/cli.ts',
    },
    resolve: true,
  },

  // External dependencies
  external: [
    '@modelcontextprotocol/sdk',
    'node:*',
    'ws',
    'uuid',
  ],

  // Development settings
  sourcemap: process.env.NODE_ENV !== 'production',
  minify: process.env.NODE_ENV === 'production',

  // CLI tool specific settings
  banner: {
    js: '#!/usr/bin/env node',
  },

  // Post-build steps
  postBuild: [
    'chmod +x dist/cli.cjs',
    'node --check dist/cli.cjs', // Validate CLI syntax
  ],

  // Watch mode for development
  watch: process.env.NODE_ENV === 'development',

  // Environment-specific defines
  define: {
    'process.env.NODE_ENV': JSON.stringify(process.env.NODE_ENV || 'development'),
  },
})
```

### package.json

```json
{
  "name": "my-mcp-server",
  "version": "1.0.0",
  "type": "module",
  "main": "./dist/index.cjs",
  "module": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "bin": {
    "my-cli": "./dist/cli.cjs"
  },
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "require": "./dist/index.cjs",
      "types": "./dist/index.d.ts"
    },
    "./server": {
      "import": "./dist/server.js",
      "require": "./dist/server.cjs",
      "types": "./dist/server.d.ts"
    }
  },
  "scripts": {
    "build": "tsup",
    "build:watch": "NODE_ENV=development tsup --watch",
    "prepublishOnly": "npm run build"
  },
  "dependencies": {
    "@modelcontextprotocol/sdk": "^0.5.0"
  },
  "devDependencies": {
    "tsup": "^8.0.2",
    "typescript": "^5.0.0"
  }
}
```

## 7. Performance Optimization Tips

### 1. Use Proper External Dependencies

```typescript
// tsup.config.ts
export default defineConfig({
  // Externalize large dependencies
  external: [
    '@modelcontextprotocol/sdk',
    'lodash',
    'axios',
  ],

  // Bundle small dependencies
  noExternal: [
    'tinyglobby',
    'picocolors',
  ],
})
```

### 2. Configure Target Appropriately

```typescript
// tsup.config.ts
export default defineConfig({
  // Target modern Node.js features
  target: 'node18',
  // Use compatible syntax
  esbuildOptions(options) {
    options.target = ['node18', 'chrome58', 'firefox57'];
  },
})
```

### 3. Optimize Bundle Size

```typescript
// tsup.config.ts
export default defineConfig({
  // Enable tree shaking
  treeshake: true,

  // Minimize in production
  minify: process.env.NODE_ENV === 'production',

  // Generate source maps for debugging
  sourcemap: process.env.NODE_ENV !== 'production',

  // Disable splitting for CLI tools
  splitting: false,
})
```

This comprehensive configuration guide should help you build efficient and well-structured MCP servers using tsup while avoiding common pitfalls.